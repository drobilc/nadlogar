{% extends "base.html" %}

{% load naloga_v_html %}

{% block naslov %}Urejanje {{ delovni_list.naslov }}{% endblock %}

{% block vsebina %}
<div class="container is-narrow">

    <div id="podatki-dokumenta" class="naloga">

        <form action="" method="post">
            {% csrf_token %}
            <label for="naslov-dokumenta" class="special-label">Osnovni podatki delovnega lista</label>
        
            <div class="form-group">
                <input type="text" class="form-control title-input-field" id="naslov-dokumenta" name="{{ delovni_list_form.naslov.name }}" value="{{ delovni_list_form.naslov.value }}">
            </div>
        
            <div class="form-group">
                <textarea name="{{ delovni_list_form.opis.name }}" id="opis-dokumenta" rows="4" class="form-control">{{ delovni_list_form.opis.value }}</textarea>
            </div>

            <div class="text-right mb-5">
                <a href="{% url 'naloge:podrobnosti_delovnega_lista' delovni_list.id %}" class="btn btn-light align-self-md-center">
                    Prekliči
                </a>
                <button type="submit" class="btn btn-primary align-self-md-center">
                    <span class="material-icons material-icons-button">save</span>
                    Shrani podatke
                </button>
            </div>
        </form>

    </div>

    <label class="special-label mt-4">Naloge</label>

    <div id="naloge" class="mb-3">
        {% for naloga in naloge %}
            <div class="naloga">

                <form action="{% url 'naloge:uredi_nalogo' delovni_list.id %}" method="post" class="uredi-nalogo">
                    {% csrf_token %}
                    <input type="hidden" name="naloga_id" value="{{ naloga.id }}">
                    <input type="hidden" name="action" value="">
                    <div class="orodna-vrstica" id="orodna-vrstica">
                        <!-- Akcijski gumbi -->
                        <div class="gumb" data-toggle="tooltip" data-placement="left" title="Odstrani nalogo">
                            <button type="submit" value="odstrani_nalogo"><span class="material-icons">delete</span></button>
                        </div>

                        <div class="gumb" data-toggle="tooltip" data-placement="left" title="Premakni gor">
                            <button type="submit" value="premakni_gor"><span class="material-icons">keyboard_arrow_up</span></button>
                        </div>

                        <div class="gumb" data-toggle="tooltip" data-placement="left" title="Premakni dol">
                            <button type="submit" value="premakni_dol"><span class="material-icons">keyboard_arrow_down</span></button>
                        </div>

                        <div class="gumb" data-toggle="tooltip" data-placement="left" title="Ustvari nove primere">
                            <button type="submit" value="ponovno_generiraj"><span class="material-icons">loop</span></button>
                        </div>

                        <div class="gumb" data-toggle="tooltip" data-placement="left" title="Uredi nalogo">
                            <button type="submit" value="uredi_nalogo"><span class="material-icons">edit</span></button>
                        </div>
                    </div>
                </form>

                <div class="primeri">
                    {{ naloga.generator_nalog | naloga_v_html }}
                </div>
            </div>
        {% endfor %}
    </div>

    <div id="dodaj-nalogo" class="text-center mb-5">
        <button class="btn btn-primary align-self-md-center" data-toggle="modal" data-target="#dodaj-nalogo-popup">
            <span class="material-icons material-icons-button">add</span>
            Dodaj nalogo
        </button>
    </div>

</div>

<div class="modal fade" id="dodaj-nalogo-popup" tabindex="-1" role="dialog" aria-labelledby="dodaj-nalogo-naslov" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title" id="dodaj-nalogo-naslov">Dodaj nalogo</h5>
                
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <form action="{% url 'naloge:dodaj_nalogo' delovni_list.id %}" method="post" id="naloga-form">
                {% csrf_token %}
                <div class="modal-body">

                    <div class="row">

                        <div class="col-8">
                            <div class="form-group">
                                <label for="vrsta-naloge">Vrsta naloge</label>
                                <select class="form-control" id="vrsta-naloge" name="{{ naloga_form.generator.name }}">
                                    {% for key, value in naloga_form.generator.field.choices %}
                                        <option value="{{ key }}">{{ value }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="col-4">
                            <div class="form-group">
                                <label for="stevilo-primerov">Število primerov</label>
                                <input type="number" class="form-control" id="stevilo-primerov" name="{{ naloga_form.stevilo_primerov.name }}" value="{{ naloga_form.stevilo_primerov.value }}">
                            </div>
                        </div>

                    </div>

                    <div class="form-group">
                        <label for="navodila">Navodila naloge</label>
                        <textarea class="form-control" id="navodila" rows="3" aria-describedby="navodila-pomoc"  name="{{ naloga_form.navodila.name }}"></textarea>
                        <small id="navodila-pomoc" class="form-text text-muted">Če pustite to polje prazno, bo za nalogo uporabljeno privzeto besedilo.</small>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-dismiss="modal">Prekliči</button>
                    <button type="submit" class="btn btn-primary">Dodaj nalogo</button>
                </div>
            </form>

        </div>
    </div>
</div>

<script>

    function ustvariNalogo(html) {
        let nalogaDiv = document.createElement('div');
        nalogaDiv.className = 'naloga';
        nalogaDiv.innerHTML = html;
        return nalogaDiv;
    }

    $(document).ready(function() {

        $('.orodna-vrstica .gumb').tooltip();

        $('#orodna-vrstica button').each(function() {
            $(this).click(function(event) {
                // Ce uporabnik klikne na enega izmed gumbov v orodni vrstici,
                // najprej prekinemo posiljanje forme
                event.preventDefault();
                let forma = $(this).closest('form');

                // Nato najdemo nevidno vnosno polje z imenom action in mu
                // nastavimo vrednost na vrednost gumba
                forma.find("input[name='action']").val($(this).val());

                // Dejansko posljemo formo
                forma.submit();
            });
        });

        // Dodaj poslusalce ob kliku na krizec, ki izbrisejo nalogo
        $(".uredi-nalogo").submit(function(event) {
            event.preventDefault();

            // Najdemo tip akcije, ki bi ga uporabnik rad izvedel
            let action = $(this).find("input[name='action']").val();

            let serializedData = $(this).serialize();
            let url = $(this).attr('action');

            let naloga = $(this).closest('.naloga');

            if (action === 'odstrani_nalogo') {
                // Skrijemo VSE tooltipe na strani
                $('[data-toggle="tooltip"]').tooltip('hide');

                // Odstranimo nalogo iz seznama nalog
                naloga.remove();
            } else if (action === 'premakni_gor') {
                // Najdemo prejsnjo nalogo in ju zamenjamo
                let prejsnjaNaloga = naloga.prev();
                if (prejsnjaNaloga) {
                    prejsnjaNaloga.before(naloga);
                }
            } else if (action === 'premakni_dol') {
                // Najdemo naslednjo nalogo in ju zamenjamo
                let naslednjaNaloga = naloga.next();
                if (naslednjaNaloga) {
                    naloga.before(naslednjaNaloga);
                }
            }

            $.ajax({
                type : 'POST',
                url :  url,
                data : serializedData,
                success : function(response) {
                    if (action === 'ponovno_generiraj') {
                        // Popravimo vsebino naloge
                        naloga.find('.primeri').html(response);
                    }
                },
                error : function(response) {
                    console.log(response)
                }
            });
            
        });

        $("#naloga-form").submit(function(event) {
            event.preventDefault();
            
            var serializedData = $(this).serialize();
            let url = $(this).attr('action');

            $.ajax({
                type : 'POST',
                url :  url,
                data : serializedData,
                success : function(response) {
                    // Ustvari novo vsebnik z nalogo in ga dodaj na stran
                    let novaNaloga = ustvariNalogo(response);
                    document.getElementById("naloge").appendChild(novaNaloga);

                    // Ponastavi obrazec za dodajanje naloge
                    $("#naloga-form")[0].reset();

                    // Zapri pojavno okno za dodajanje naloge
                    $('#dodaj-nalogo-popup').modal('hide');

                    // Scollaj do novo dodanega elementa
                    novaNaloga.scrollIntoView({ behavior: 'smooth' });
                },
                error : function(response) {
                    console.log(response)
                }
            });
        });
    });

</script>

{% endblock %}